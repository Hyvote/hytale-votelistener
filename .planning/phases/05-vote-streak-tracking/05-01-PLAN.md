---
phase: 05-vote-streak-tracking
plan: 01
type: execute
depends_on: []
files_modified:
  - src/main/java/com/hyvote/votelistener/data/PlayerVoteData.java
  - src/main/java/com/hyvote/votelistener/data/VoteDataManager.java
  - src/main/java/com/hyvote/votelistener/HytaleVoteListener.java
---

<objective>
Implement player vote data storage with JSON persistence and streak calculation logic.

Purpose: Track when each player last voted and maintain their consecutive daily vote streak count.
Output: PlayerVoteData model, VoteDataManager for file-based storage, and streak calculation logic.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key files from prior phases:
@src/main/java/com/hyvote/votelistener/config/ConfigManager.java
@src/main/java/com/hyvote/votelistener/config/Config.java
@src/main/java/com/hyvote/votelistener/HytaleVoteListener.java

**Tech stack available:** gson-2.10.1, maven-shade-plugin for bundling
**Established patterns:** JSON config model pattern, manager class for file I/O, immutable config models
**Constraining decisions:**
- Phase 01-01: GSON shaded and relocated to avoid conflicts
- Phase 03-01: ConfigManager pattern for JSON file load/save with Gson
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PlayerVoteData model</name>
  <files>src/main/java/com/hyvote/votelistener/data/PlayerVoteData.java</files>
  <action>
Create PlayerVoteData class in new `data` subpackage with fields:
- String uuid (player UUID as string for JSON serialization)
- String username (for logging/display)
- int totalVotes (lifetime vote count)
- int currentStreak (consecutive daily votes)
- long lastVoteTimestamp (epoch millis of last vote)

Include:
- Default constructor for Gson
- Constructor with all fields
- Getter methods for all fields
- Setter methods for mutable fields (totalVotes, currentStreak, lastVoteTimestamp, username)

Follow immutable-after-load pattern from RandomReward where possible, but allow mutation since this is player state that changes.
  </action>
  <verify>File compiles: mvn compile -q</verify>
  <done>PlayerVoteData.java exists with all fields, constructors, getters, setters</done>
</task>

<task type="auto">
  <name>Task 2: Create VoteDataManager with streak calculation</name>
  <files>src/main/java/com/hyvote/votelistener/data/VoteDataManager.java</files>
  <action>
Create VoteDataManager class following ConfigManager pattern with:
- VOTE_DATA_FILE_NAME = "vote-data.json"
- Map&lt;String, PlayerVoteData&gt; voteDataMap (keyed by UUID)
- Gson instance for JSON serialization
- Path pluginDataFolder and Logger injected via constructor

Methods:
1. loadVoteData() - Load vote-data.json into map, create empty file if missing
2. saveVoteData() - Write map to vote-data.json with pretty printing
3. getOrCreatePlayerData(String uuid, String username) - Get existing or create new PlayerVoteData
4. recordVote(String uuid, String username) - Core logic:
   - Get/create player data
   - Increment totalVotes
   - Calculate streak: if lastVote was yesterday (24-48 hours ago), increment streak. If more than 48 hours ago, reset streak to 1. If same day, do not change streak (already voted today).
   - Update lastVoteTimestamp to now
   - Save data immediately (file-based persistence)
   - Return updated PlayerVoteData

Streak calculation logic (use java.time APIs):
- Get current LocalDate and lastVote LocalDate from timestamp
- If same day: streak unchanged (already voted today)
- If yesterday: currentStreak++
- If older than yesterday: currentStreak = 1

Use ZoneId.systemDefault() for date conversion.
  </action>
  <verify>mvn compile -q succeeds</verify>
  <done>VoteDataManager loads/saves JSON, recordVote calculates streaks correctly, getOrCreatePlayerData works</done>
</task>

<task type="auto">
  <name>Task 3: Integrate VoteDataManager into plugin lifecycle</name>
  <files>src/main/java/com/hyvote/votelistener/HytaleVoteListener.java</files>
  <action>
Add VoteDataManager to HytaleVoteListener:
1. Add private VoteDataManager voteDataManager field
2. In setup(): Initialize voteDataManager with pluginDataFolder and logger, call loadVoteData()
3. Add getter: getVoteDataManager() returning voteDataManager
4. In shutdown(): Log that vote data was saved (VoteDataManager saves immediately so no pending save needed)

The VoteDataManager instance will be passed to VoteListener in plan 05-02.
  </action>
  <verify>mvn compile -q succeeds, no errors</verify>
  <done>VoteDataManager initialized in setup(), accessible via getter, lifecycle complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `mvn compile -q` succeeds without errors
- [ ] PlayerVoteData.java exists in data package with all fields
- [ ] VoteDataManager.java exists with load/save/recordVote methods
- [ ] HytaleVoteListener initializes VoteDataManager in setup()
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No compilation errors
- PlayerVoteData and VoteDataManager follow established patterns
</success_criteria>

<output>
After completion, create `.planning/phases/05-vote-streak-tracking/05-01-SUMMARY.md`
</output>
