---
phase: 04-random-rewards
plan: 02
type: execute
depends_on: ["04-01"]
files_modified:
  - src/main/java/com/hyvote/votelistener/listener/VoteListener.java
---

<objective>
Integrate random reward selection into VoteListener vote handling.

Purpose: When a player votes, select a random reward based on weighted chances and execute its commands.
Output: VoteListener executes random reward commands in addition to guaranteed commands on each vote.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-random-rewards/04-01-SUMMARY.md

**Key files:**
@src/main/java/com/hyvote/votelistener/listener/VoteListener.java
@src/main/java/com/hyvote/votelistener/config/Config.java
@src/main/java/com/hyvote/votelistener/reward/RewardSelector.java

**Established patterns:**
- PlaceholderProcessor.process() for command replacement
- config.isDebugMode() for verbose logging
- Commands executed via server.executeCommand()
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate random rewards into VoteListener</name>
  <files>src/main/java/com/hyvote/votelistener/listener/VoteListener.java</files>
  <action>
Update onVote() method to handle random rewards after guaranteed commands:

1. Add import for RewardSelector and RandomReward
2. After executing guaranteed commands (existing code), add random reward logic:
   - Check if config.isRandomRewardsEnabled()
   - If enabled, call RewardSelector.select(config.getRandomRewards())
   - If selected reward is not null:
     - Log "Selected random reward: {name}" at info level
     - Iterate reward.getCommands() and execute each with PlaceholderProcessor
     - If debugMode: log each executed reward command

Order of execution in onVote():
1. Log vote received (existing)
2. Execute guaranteed commands (existing)
3. Execute random reward commands (new)
4. Handle broadcast vote (existing)

Do NOT modify the guaranteed commands logic - random rewards are additional.
  </action>
  <verify>VoteListener calls RewardSelector.select() and executes returned reward commands</verify>
  <done>VoteListener executes random reward on each vote when enabled</done>
</task>

<task type="auto">
  <name>Task 2: Add reward name placeholder</name>
  <files>src/main/java/com/hyvote/votelistener/util/PlaceholderProcessor.java</files>
  <action>
Add overloaded process() method that accepts reward name:
- public static String process(String command, Vote vote, String rewardName)
- Adds %reward% placeholder replacement with rewardName parameter
- Call existing process(command, vote) first, then replace %reward%

This allows commands like "say %player% received a %reward% reward!" to work within random reward command lists.

Keep existing process(String, Vote) method unchanged for backward compatibility.
  </action>
  <verify>PlaceholderProcessor.process(cmd, vote, "legendary") replaces %reward% with "legendary"</verify>
  <done>PlaceholderProcessor supports %reward% placeholder in overloaded method</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] VoteListener imports RewardSelector and RandomReward
- [ ] onVote() selects random reward when randomRewardsEnabled is true
- [ ] Random reward commands are executed with placeholder replacement
- [ ] PlaceholderProcessor supports %reward% placeholder
- [ ] Debug logging shows selected reward name and executed commands
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors introduced
- Random rewards execute on vote with proper logging
- Phase 4 complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-random-rewards/04-02-SUMMARY.md`
</output>
