---
phase: 08-reward-delivery
plan: 01
type: execute
depends_on: []
files_modified: [src/main/java/com/hyvote/votelistener/listener/PlayerJoinListener.java, src/main/java/com/hyvote/votelistener/HytaleVoteListener.java]
---

<objective>
Create PlayerJoinListener to auto-deliver pending rewards when offline players return to the server.

Purpose: Fulfill the core promise of offline vote handling - rewards are automatically delivered when the player logs in, ensuring no vote reward is ever lost.
Output: PlayerJoinListener class registered with EventBus, pending rewards delivered on login.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@.planning/phases/08-reward-delivery/08-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 7 summaries (direct dependency - offline storage infrastructure)
@.planning/phases/07-offline-vote-storage/07-01-SUMMARY.md
@.planning/phases/07-offline-vote-storage/07-02-SUMMARY.md

# Phase 2 summary (event listener pattern reference)
@.planning/phases/02-vote-event-listener/02-01-SUMMARY.md

# Key source files
@src/main/java/com/hyvote/votelistener/HytaleVoteListener.java
@src/main/java/com/hyvote/votelistener/data/PendingRewardsManager.java
@src/main/java/com/hyvote/votelistener/data/PendingReward.java
@src/main/java/com/hyvote/votelistener/listener/VoteListener.java

**Tech stack available:**
- GSON for JSON (shaded)
- HytaleVotifier event system
- EventBus subscription pattern

**Established patterns:**
- EventBus subscription: `server.getEventBus().subscribe(EventClass, handler::method)`
- Listener subpackage: `com.hyvote.votelistener.listener`
- Constructor injection for Server, Logger, and dependencies
- PendingRewardsManager: `getPendingRewards(uuid)`, `hasPendingRewards(uuid)`, `clearPendingRewards(uuid)`

**Constraining decisions:**
- Phase 07-01: Commands stored pre-processed (placeholders already replaced) for exact delivery
- Phase 07-02: Broadcast vote always immediate (not relevant for delivery)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PlayerJoinListener class in listener subpackage</name>
  <files>src/main/java/com/hyvote/votelistener/listener/PlayerJoinListener.java</files>
  <action>
Create PlayerJoinListener class following VoteListener pattern:
- Package: com.hyvote.votelistener.listener
- Constructor takes Server, Logger, PendingRewardsManager
- onPlayerJoin(PlayerJoinEvent event) handler method:
  1. Get player UUID and username from event
  2. Check hasPendingRewards(uuid)
  3. If no pending rewards, return early
  4. Log "Delivering X pending vote rewards to {username}"
  5. Iterate getPendingRewards(uuid), for each PendingReward:
     - Log reward details (service name, command count) if debug mode needed
     - Execute each command from reward.getCommands() via server.executeCommand()
  6. After successful delivery, call clearPendingRewards(uuid)
  7. Send player message: "You received X pending vote rewards! Thank you for voting!"

Use PlayerJoinEvent from com.hypixel.hytale.server.event (standard Hytale server event).
Player UUID available via event.getPlayer().getUniqueId().toString().
Player username via event.getPlayer().getName().
  </action>
  <verify>File exists at path, compiles with `mvn compile -q`</verify>
  <done>PlayerJoinListener.java created with onPlayerJoin handler that delivers and clears pending rewards</done>
</task>

<task type="auto">
  <name>Task 2: Register PlayerJoinListener in plugin lifecycle</name>
  <files>src/main/java/com/hyvote/votelistener/HytaleVoteListener.java</files>
  <action>
Integrate PlayerJoinListener following VoteListener pattern:
1. Add import for PlayerJoinListener and PlayerJoinEvent
2. Add private field: `private PlayerJoinListener playerJoinListener;`
3. In start() method after VoteListener registration:
   - Create: `playerJoinListener = new PlayerJoinListener(getServer(), getLogger(), pendingRewardsManager);`
   - Register: `getServer().getEventBus().subscribe(PlayerJoinEvent.class, playerJoinListener::onPlayerJoin);`
   - Log: "Registered player join listener for pending reward delivery"
4. In shutdown() add cleanup logging for playerJoinListener (matches VoteListener pattern)
  </action>
  <verify>mvn compile -q passes, plugin loads without errors</verify>
  <done>PlayerJoinListener registered in plugin lifecycle, pending rewards delivered on player join</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `mvn compile -q` succeeds without errors
- [ ] PlayerJoinListener.java exists in listener subpackage
- [ ] HytaleVoteListener.java has PlayerJoinListener field and registration
- [ ] Event subscription follows established pattern
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No compile errors introduced
- PlayerJoinListener automatically delivers pending rewards on player login
</success_criteria>

<output>
After completion, create `.planning/phases/08-reward-delivery/08-01-SUMMARY.md`
</output>
