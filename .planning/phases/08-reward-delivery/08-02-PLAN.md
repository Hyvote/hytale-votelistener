---
phase: 08-reward-delivery
plan: 02
type: execute
depends_on: ["08-01"]
files_modified: [src/main/java/com/hyvote/votelistener/command/ClaimVotesCommand.java, src/main/java/com/hyvote/votelistener/HytaleVoteListener.java]
---

<objective>
Create /claimvotes command for manual reward claiming with permission checks.

Purpose: Provide players a manual way to claim pending vote rewards, useful for edge cases where auto-delivery might miss rewards or for players who want explicit control.
Output: /claimvotes command registered with permission check, delivers pending rewards on demand.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@.planning/phases/08-reward-delivery/08-02-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 8 Plan 01 summary (PlayerJoinListener pattern)
@.planning/phases/08-reward-delivery/08-01-SUMMARY.md

# Phase 7 summaries (pending rewards infrastructure)
@.planning/phases/07-offline-vote-storage/07-01-SUMMARY.md

# Key source files
@src/main/java/com/hyvote/votelistener/HytaleVoteListener.java
@src/main/java/com/hyvote/votelistener/data/PendingRewardsManager.java
@src/main/java/com/hyvote/votelistener/data/PendingReward.java

**Tech stack available:**
- GSON for JSON (shaded)
- Hytale command system

**Established patterns:**
- PendingRewardsManager: `getPendingRewards(uuid)`, `hasPendingRewards(uuid)`, `clearPendingRewards(uuid)`
- Commands stored pre-processed for exact delivery

**Constraining decisions:**
- Phase 07-01: Commands stored pre-processed (placeholders already replaced)
- Phase 08-01: PlayerJoinListener provides delivery pattern to follow
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ClaimVotesCommand class in command subpackage</name>
  <files>src/main/java/com/hyvote/votelistener/command/ClaimVotesCommand.java</files>
  <action>
Create ClaimVotesCommand class:
- Package: com.hyvote.votelistener.command (new subpackage)
- Implement CommandExecutor interface from Hytale server API (com.hypixel.hytale.server.command.CommandExecutor)
- Constructor takes Server, Logger, PendingRewardsManager
- Permission: "hyvote.claimvotes" (check via sender.hasPermission())

execute(CommandSender sender, String label, String[] args) method:
1. Check sender is Player (not console): `if (!(sender instanceof Player))` return with "This command can only be used by players"
2. Cast to Player, get UUID and username
3. Check permission "hyvote.claimvotes" - if not, return "You don't have permission to use this command"
4. Check hasPendingRewards(uuid) - if not, send "You have no pending vote rewards to claim"
5. Get pending rewards list, count total rewards
6. Deliver each reward (same pattern as PlayerJoinListener):
   - For each PendingReward, execute each command via server.executeCommand()
7. Clear pending rewards after successful delivery
8. Send success message: "Claimed X pending vote rewards! Thank you for voting!"
9. Log delivery for audit trail
  </action>
  <verify>File exists at path, compiles with `mvn compile -q`</verify>
  <done>ClaimVotesCommand.java created with execute handler that claims pending rewards with permission check</done>
</task>

<task type="auto">
  <name>Task 2: Register /claimvotes command in plugin lifecycle</name>
  <files>src/main/java/com/hyvote/votelistener/HytaleVoteListener.java</files>
  <action>
Integrate ClaimVotesCommand:
1. Add import for ClaimVotesCommand
2. Add private field: `private ClaimVotesCommand claimVotesCommand;`
3. In start() method after listener registrations:
   - Create: `claimVotesCommand = new ClaimVotesCommand(getServer(), getLogger(), pendingRewardsManager);`
   - Register command: `getServer().getCommandRegistry().register("claimvotes", claimVotesCommand);`
   - Log: "Registered /claimvotes command"
4. In shutdown() add cleanup logging for claimVotesCommand

Note: Use Hytale's CommandRegistry API for command registration. If the API differs, adapt to match the server's command registration pattern.
  </action>
  <verify>mvn compile -q passes, /claimvotes command responds when typed</verify>
  <done>/claimvotes command registered and functional with permission check</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `mvn compile -q` succeeds without errors
- [ ] ClaimVotesCommand.java exists in command subpackage
- [ ] HytaleVoteListener.java has ClaimVotesCommand field and registration
- [ ] Permission check implemented for "hyvote.claimvotes"
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No compile errors introduced
- /claimvotes command delivers pending rewards with permission check
- Phase 8 complete - all reward delivery mechanisms implemented
</success_criteria>

<output>
After completion, create `.planning/phases/08-reward-delivery/08-02-SUMMARY.md`

**Phase 8 complete criteria:** Both auto-delivery (PlayerJoinListener) and manual delivery (/claimvotes) are functional.
</output>
