---
phase: 07-offline-vote-storage
plan: 02
type: execute
depends_on: ["07-01"]
files_modified: [src/main/java/com/hyvote/votelistener/listener/VoteListener.java]
---

<objective>
Integrate pending rewards queue into VoteListener to handle offline player votes.

Purpose: When a player votes while offline, queue their rewards for later delivery instead of executing immediately.
Output: VoteListener checks player online status and either executes rewards immediately or queues them.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-offline-vote-storage/07-01-SUMMARY.md

**From Plan 07-01:**
- PendingReward model with uuid, username, serviceName, timestamp, commands
- PendingRewardsManager with addPendingReward(), available via plugin.getPendingRewardsManager()

**Key files to reference:**
@src/main/java/com/hyvote/votelistener/listener/VoteListener.java
@src/main/java/com/hyvote/votelistener/data/PendingRewardsManager.java
@src/main/java/com/hyvote/votelistener/data/PendingReward.java

**Established patterns:**
- VoteListener receives Server instance in constructor
- Commands are processed through PlaceholderProcessor before execution
- server.executeCommand() for command execution
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PendingRewardsManager to VoteListener and implement offline detection</name>
  <files>src/main/java/com/hyvote/votelistener/listener/VoteListener.java</files>
  <action>
Update VoteListener constructor and add pending rewards support:

1. Add PendingRewardsManager field to VoteListener
2. Update constructor to accept PendingRewardsManager parameter
3. Add private helper method isPlayerOnline(String username):
   - Use server.getPlayerByName(username) != null
   - If that API doesn't exist, try server.getOnlinePlayers() and check if any match username
   - Return boolean

4. Refactor onVote() to collect all commands into a List<String> before execution:
   - Create List<String> allCommands = new ArrayList<>()
   - Instead of executing each command immediately, add processed commands to allCommands
   - This includes: base commands, random reward commands, streak bonus commands, milestone bonus commands
   - Keep broadcast vote separate (always executes immediately since it's server-wide)

5. After collecting all commands, check if player is online:
   - If online: execute all commands immediately (existing behavior)
   - If offline: create PendingReward with uuid, username, serviceName, timestamp, commands list
   - Call pendingRewardsManager.addPendingReward(uuid, pendingReward)
   - Log: "Player {username} is offline, queued {N} reward commands for later delivery"

6. Update HytaleVoteListener.start() to pass pendingRewardsManager to VoteListener constructor
  </action>
  <verify>
- VoteListener constructor accepts PendingRewardsManager
- isPlayerOnline() helper method exists
- onVote() collects commands and checks online status
- Offline votes queue to PendingRewardsManager
- HytaleVoteListener.start() passes pendingRewardsManager to VoteListener
  </verify>
  <done>
- VoteListener detects offline players and queues rewards
- Online players receive rewards immediately (unchanged behavior)
- Pending rewards stored via PendingRewardsManager
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] VoteListener has PendingRewardsManager field and updated constructor
- [ ] isPlayerOnline() helper method works
- [ ] onVote() collects all reward commands before execution
- [ ] Offline players get rewards queued, not executed
- [ ] Online players still receive immediate rewards
- [ ] HytaleVoteListener.start() updated to pass pendingRewardsManager
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Vote processing for online players unchanged
- Offline player votes result in queued pending rewards
- Phase 7 complete (offline vote storage functional)
</success_criteria>

<output>
After completion, create `.planning/phases/07-offline-vote-storage/07-02-SUMMARY.md`
</output>
