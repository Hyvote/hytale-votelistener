---
phase: 07-offline-vote-storage
plan: 01
type: execute
depends_on: []
files_modified: [src/main/java/com/hyvote/votelistener/data/PendingReward.java, src/main/java/com/hyvote/votelistener/data/PendingRewardsManager.java, src/main/java/com/hyvote/votelistener/HytaleVoteListener.java]
---

<objective>
Create data layer for storing pending rewards when players vote while offline.

Purpose: Enable reward persistence so votes received while a player is offline can be delivered when they return.
Output: PendingReward model, PendingRewardsManager with JSON persistence, plugin lifecycle integration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Established patterns (from prior phases):**
- Data subpackage: com.hyvote.votelistener.data for persistence models
- VoteDataManager pattern: load/save/record with automatic JSON persistence
- Gson with setPrettyPrinting() for human-readable JSON files
- TypeToken for generic type deserialization
- Immediate save after modifications for data integrity

**Key files to reference:**
@src/main/java/com/hyvote/votelistener/data/PlayerVoteData.java
@src/main/java/com/hyvote/votelistener/data/VoteDataManager.java
@src/main/java/com/hyvote/votelistener/HytaleVoteListener.java

**Tech stack available:** Gson 2.10.1 (shaded)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PendingReward model class</name>
  <files>src/main/java/com/hyvote/votelistener/data/PendingReward.java</files>
  <action>
Create PendingReward.java in the data package following PlayerVoteData pattern.

Fields:
- uuid: String (player UUID)
- username: String (player name at time of vote)
- serviceName: String (voting service name for logging)
- timestamp: long (when vote was received, System.currentTimeMillis())
- commands: List<String> (fully processed commands ready to execute)

Include:
- Constructor with all fields
- Getters for all fields
- No setters needed (immutable after creation)
- Javadoc explaining this stores rewards for offline players

The commands list stores already-processed commands (placeholders replaced) so we don't need to recalculate random rewards or streaks when delivering later.
  </action>
  <verify>File exists at src/main/java/com/hyvote/votelistener/data/PendingReward.java with all fields and getters</verify>
  <done>PendingReward model class created with uuid, username, serviceName, timestamp, commands fields</done>
</task>

<task type="auto">
  <name>Task 2: Create PendingRewardsManager and integrate into plugin lifecycle</name>
  <files>src/main/java/com/hyvote/votelistener/data/PendingRewardsManager.java, src/main/java/com/hyvote/votelistener/HytaleVoteListener.java</files>
  <action>
Create PendingRewardsManager.java following VoteDataManager pattern exactly:

Constructor:
- Path pluginDataFolder
- Logger logger
- Initialize Gson with setPrettyPrinting()
- Initialize empty Map<String, List<PendingReward>> pendingRewardsMap

Methods:
- loadPendingRewards(): Load from pending-rewards.json, create empty file if not exists
- savePendingRewards(): Save map to JSON, create directory if needed
- addPendingReward(String uuid, PendingReward reward): Add to list for player, call savePendingRewards()
- getPendingRewards(String uuid): Return list or empty list if none
- clearPendingRewards(String uuid): Remove all pending for player, call savePendingRewards()
- hasPendingRewards(String uuid): Return boolean

Use TypeToken<Map<String, List<PendingReward>>> for Gson deserialization.

Then update HytaleVoteListener.java:
- Add private PendingRewardsManager pendingRewardsManager field
- In setup(): Initialize and load pending rewards (after voteDataManager)
- Add getPendingRewardsManager() getter
- In shutdown(): Log pending rewards status
  </action>
  <verify>
Files exist:
- src/main/java/com/hyvote/votelistener/data/PendingRewardsManager.java
- HytaleVoteListener has pendingRewardsManager field and getter
  </verify>
  <done>PendingRewardsManager created with load/save/add/get/clear/has methods, integrated into plugin lifecycle</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] PendingReward.java exists with all required fields
- [ ] PendingRewardsManager.java exists with all required methods
- [ ] HytaleVoteListener.java has pendingRewardsManager field, initialization in setup(), and getter
- [ ] Code follows existing VoteDataManager patterns exactly
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- PendingReward model is immutable with all fields
- PendingRewardsManager follows VoteDataManager pattern
- Plugin lifecycle properly initializes pending rewards manager
</success_criteria>

<output>
After completion, create `.planning/phases/07-offline-vote-storage/07-01-SUMMARY.md`
</output>
